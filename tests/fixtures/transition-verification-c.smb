lang: c

# udea is to go thru different kinds of transitions.
# * In the plane
# * Up.
# * Down
# * Into a leg with history
# * Into a orhtogoanl state
# From a state with internal states

# main should count up a counter each time it runs a tick.
# At each new value it should compare the state_full_name with predicted.
#

includes: |
  void p(const char* s) {
    printf("%s\n", s);
  }
  void finish(SM_Context* ctx) {
    ctx->do_loop = false;
  }


# C-specific fields
context: |
    int counter;
    bool do_loop;

# How to initialize the above fields (runs after memset in sm_init)
context_init: |
    sm->ctx.counter = 0;
    sm->ctx.do_loop = true;

hooks:
  entry: |
    printf("%02d: Entry: %s\n", ctx->counter, state_full_name);

  exit: |
    printf("%02d: Exit: %s\n", ctx->counter, state_full_name);

  do: |
    printf("%02d: Running: %s\n", ctx->counter, state_full_name);

  transition: |
    printf("%02d: Transition from %s to %s\n", ctx->counter, t_src, t_dst);


entry: |
  printf("%s\n", "System Start");
do: |
  //printf("%s\n", "Running root");
exit: |
  printf("%s\n", "Done");

initial: run

states:

  run:
    initial: a
    transitions:
      - guard: ctx->counter == 8
        to: /run/d
      - guard: ctx->counter == 19
        to: /run/a


    states:
      a:
        transitions:
          - guard: ctx->counter == 1
            action: |
              printf("First transiton\n");
            to: b
          - guard: ctx->counter == 3
            to: /run/c
          - guard: ctx->counter == 5
            to: /run/c/d
          - guard: ctx->counter == 11
            action: p("Testing history");
            to: /run/d
          - guard: ctx->counter == 16
            to: /run/g
          - guard: ctx->counter == 20
            to: /run/g/[a/b,b/a]
          - guard: ctx->counter == 22
            to: /run/g/a/b


      b:
        transitions:
          - guard: ctx->counter == 2
            to: a

      c:
        initial: d
        states:

          d:
            transitions:
              - guard: ctx->counter == 4
                to: /run
              - guard: ctx->counter == 6
                to: /run/c/d
              - guard: ctx->counter == 7
                to: /run/c/e

          e:
            initial: f
            states:
              f:
                transitions:
                  - guard: false
                    to: /run/a
      d:
        history: true
        initial: a

        states:
          a:
            transitions:
              - guard: ctx->counter == 9
                to: b
          b:
            transitions:
              - guard: ctx->counter == 10
                to: /run/a
              - guard: ctx->counter == 12
                action: p("Testing parallel");
                to: /run/g

      g:
        orthogonal: true
        states:
          a:
            initial: a
            states:
              a:
                transitions:
                  - guard: ctx->counter == 14 || ctx->counter == 18
                    to: b
              b:
                transitions:
                  - guard: ctx->counter == 15
                    to: /run/a
                  - guard: ctx->counter == 21
                    to: /run/a
                  - guard: ctx->counter == 23
                    to: /run/g/b/c
          b:
            initial: b
            states:
              a: { }
              b:
                transitions:
                  - guard: ctx->counter == 13 || ctx->counter == 17
                    to: c
              c:
                transitions:
                  - guard: ctx->counter == 14 || ctx->counter == 18
                    to: a
                  - guard: ctx->counter == 24
                    action: p("Trying a descision tree");
                    to: /run/h

      h:
        initial: a
        decisions:
          d1:
            - guard: ctx->counter == 200
              to: /error
            - guard: ctx->counter == 25
              to: b
            - guard: ctx->counter == 26
              to: a
            - guard: ctx->counter > 26
              to: "@d2"
          d2:
            - guard: ctx->counter == 27
              to: c
            - guard: ctx->counter == 28
              to: b
        states:
          a:
            transitions:
              - to: "@d1"
          b:
            transitions:
              - to: "@d1"
              - guard: ctx->counter == 29
                to: null
          c:
            transitions:
              - to: "@d1"

  error:
    entry: //



